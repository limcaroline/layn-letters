{% extends "base.html" %}
{% block title %}{{ object.title }} — Review{% endblock %}

{% block content %}
<article>
  <h1 class="h4">{{ object.title }}</h1>

  <p class="mb-1">
    <strong>{{ object.place.name }}</strong>
    {% if object.place.city or object.place.country %}
      — {{ object.place.city }}{% if object.place.city and object.place.country %}, {% endif %}{{ object.place.country }}
    {% endif %}
  </p>

  <p class="mb-1">
    Rating:
    <span class="badge text-bg-primary">★ {{ object.rating }}</span>
    {% if place_avg %}
      <span class="text-muted small ms-2">
        Place avg: {{ place_avg|floatformat:1 }}/5
      </span>
    {% endif %}
  </p>

  <p class="small text-muted mb-3">
    by {{ object.author }} · {{ object.created|date:"M j, Y" }}
    {% if object.visited_on %}
      · visited: {{ object.visited_on|date:"M j, Y" }}
    {% endif %}
  </p>

  {% if object.body %}
    <div class="mb-4">
      {{ object.body|linebreaks }}
    </div>
  {% endif %}

  {% if user.is_authenticated and user == object.author %}
    <div class="mb-4">
      <a class="btn btn-outline-secondary"
         href="{% url 'reviews:edit' object.pk %}">Edit</a>
      <a class="btn btn-outline-danger"
         href="{% url 'reviews:delete' object.pk %}">Delete</a>
    </div>
  {% endif %}
</article>

<hr>

<section>
  <h2 class="h5 mb-3">Comments</h2>

  {% for c in comments %}
    <div class="mb-3 border rounded p-2">
      <p class="mb-1">{{ c.body|linebreaks }}</p>
      <p class="small text-muted mb-1">
        by {{ c.author }} · {{ c.created|date:"M j, Y H:i" }}
      </p>
      <div class="d-flex align-items-center gap-2">
        <span class="small">Score: {{ c.score|default:"0" }}</span>
        {% if user.is_authenticated %}
          <form method="post"
                action="{% url 'reviews:comment_vote' c.pk %}"
                class="d-inline me-1">
            {% csrf_token %}
            <input type="hidden" name="value" value="1">
            <button class="btn btn-sm btn-outline-success" type="submit">+</button>
          </form>
          <form method="post"
                action="{% url 'reviews:comment_vote' c.pk %}"
                class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="value" value="-1">
            <button class="btn btn-sm btn-outline-danger" type="submit">-</button>
          </form>
        {% endif %}

        {% if user.is_authenticated %}
            {% if user == c.author or user.is_staff %}
                <a class="btn btn-sm btn-outline-secondary ms-2"
                    href="{% url 'reviews:comment_edit' c.pk %}">Edit</a>
                <a class="btn btn-sm btn-outline-danger"
                    href="{% url 'reviews:comment_delete' c.pk %}">Delete</a>
            {% endif %}
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p class="text-muted">No comments yet.</p>
  {% endfor %}
</section>

{% if user.is_authenticated %}
  <hr>
  <section class="mt-3">
    <h3 class="h6">Add a comment</h3>
    <form method="post">
      {% csrf_token %}
      {{ comment_form.non_field_errors }}
      <div class="mb-3">
        {{ comment_form.body }}
        {{ comment_form.body.errors }}
      </div>
      <button class="btn btn-primary btn-sm">Post comment</button>
    </form>
  </section>
{% else %}
  <p class="mt-3">
    <a href="{% url 'account_login' %}">Log in</a> to comment.
  </p>
{% endif %}
{% endblock %}
